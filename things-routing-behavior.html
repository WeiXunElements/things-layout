<link rel="import" href="../things-detail/things-menu-detail-view.html">

<script>
'use strict';

window.Things = window.Things || {};

/**
 * This behavior is for routing registration when menu or other element need to use routing registration.
 * On standard we used this behavior on things-sidebar.html
 * 
 * @polymerBehavior Things.RoutingBehavior
 */
Things.RoutingBehavior = {

  properties:{
    /**
     * 현재 선택된 메뉴 정보 
     */
    selectedMenu: {
      type: Object
    }
  },

  /**
   * Initialize routings
   *
   * @param {Array} Menu screen array
   * @param {String} Defualt routing name
   * @param {String} Login routing name  
   */
  init: function(screens, defaultRouting, loginRouting) {
    var me = this;
    this.addDefaultRouting(defaultRouting, loginRouting);

    screens.forEach(function(screen) {
      var route = screen.routing;
      if (route) {
        page('/' + screen.routing, me.scrollToTop, function() {
          app.route = screen.routing;

          // Dynamic Menu라면 Element가 등록되었는지 확인한 후 등록이 안 되었다면 등록한다.
          if(!screen.isRegistered) {
            if(screen.routing_type == 'DIY' || screen.routing_type == 'RESOURCE') {
              me._registerResourceScreen(screen);
            } else if (screen.routing_type == 'VIEWER') {
              me._registerViewerScreen(screen);
            } else {
              me._registerStaticScreen(screen);
            }

            screen.isRegistered = true;
          }

          var eventDetail = { pageName: screen.title, routeInfo: screen.routing, category: screen.category };
          me.selectedMenu = eventDetail;
          var event = new CustomEvent('things-routing-changed', { 'detail': eventDetail });
          document.dispatchEvent(event);
        });
      }
    });

    this.addLastRouting();
  },

  /**
   * RESOURCE 타입의 Dynamic Screen을 등록한다.
   * 
   * @param {Object} menuData
   */
  _registerResourceScreen: function(menuData) {
    var content = document.querySelector('#' + this.pageContentId);
    var screenName = (menuData.category == 'TERMINAL') ? 'things-menu-detail-view' : 
                     (menuData.resource_type == 'DIY_GRID' ? 'things-report-content' : 'things-resource-menu-content');
    var screen = document.createElement(screenName);
    screen.menuInfo = menuData;
    screen.dataRoute = menuData.routing;
    Polymer.dom(content).appendChild(screen);
    Polymer.dom.flush();
  },

  /**
   * VIEWER 타입의 Dynamic Viewer를 등록한다.
   * 
   * @param {Object} menuData
   */
  _registerViewerScreen: function(menuData) {
    var content = document.querySelector('#' + this.pageContentId);
    var screenName = 'things-scene-content';
    var screen = document.createElement(screenName);
    screen.menuInfo = menuData;
    screen.dataRoute = menuData.routing;
    Polymer.dom(content).appendChild(screen);
    Polymer.dom.flush();
  },  

  /**
   * STATIC 타입의 Screen을 등록한다.
   * 
   * @param {Object} menuData
   */
  _registerStaticScreen: function(menuData) {
    var content = document.querySelector('#' + this.pageContentId);
    var screen = document.createElement(menuData.template);
    screen.menuInfo = menuData;
    screen.dataRoute = menuData.routing;
    Polymer.dom(content).appendChild(screen);
    Polymer.dom.flush();
  },

  /**
   * move screen scroll to top
   */
  scrollToTop: function(ctx, next) {
    //app.scrollPageToTop();
    next();
  },

  /**
   *  add default routing
   *  @param {String} Default routing name
   */
  addDefaultRouting: function(defaultRouting, loginRouting) {

    page('/'+defaultRouting, this.scrollToTop, function() {
      app.route = defaultRouting;
    });

    page('/', this.scrollToTop, function() {
      if(defaultRouting!=='home')
        page.redirect(defaultRouting)
      else
        app.route = defaultRouting;
      
    });

    page('/login', this.scrollToTop, function() {
      app.route = loginRouting;
    });
  },

  /**
   * add last routing, when page not foud redirect to home
   */
  addLastRouting: function() {
    page('*', function(attempted) {
      var url = window.location.href + attempted.path.substr(1);
      // app.$.toastConfirm.text = `Can't find: ${url}. Redirected you to Home Page`;
      // app.$.toastConfirm.show();
      page.redirect('/');
    });
    
    page({
      hashbang: true
    });
  }
};

</script>
