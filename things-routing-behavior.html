<script>
'use strict';

window.Things = window.Things || {};
/**
 * This behavior is for routing registration when menu or other element need to use routing registration.
 * On standard we used this behavior on things-sidebar.html
 * 
 * @polymerBehavior Things.RoutingBehavior
 */
Things.RoutingBehavior = {

  /**
   * initialize routings
   * @param {Array} Menu screen array
   * @param {String} Defualt routing name
   * @param {String} Login routing name  
   */
  init: function(screens, defaultRouting, loginRouting) {
    var me = this;
    this.addDefaultRouting(defaultRouting, loginRouting);

    screens.forEach(function(screen) {
      var route = screen.routing;
      if (route) {
        page('/' + screen.routing, me.scrollToTop, () => {
          app.route = screen.routing;

          // Dynamic Menu라면 Element가 등록되었는지 확인한 후 등록이 안 되었다면 등록한다.
          if(!screen.isRegistered) {
            if(screen.routing_type == 'DIY') {
              me._registerDiyScreen(screen);

            } else if(screen.routing_type == 'RESOURCE') {
              me._registerResourceScreen(screen);
            }

            screen.isRegistered = true;
          }

          var eventDetail = { pageName: screen.title, routeInfo: screen.routing };
          var event = new CustomEvent('things-recent-page-add', { 'detail': eventDetail });
          document.dispatchEvent(event);          
        });
      }
    });

    this.addLastRouting();
  },

  /**
   * DIY 타입의 Dynamic Screen을 등록한다.
   * 
   * @param {Object} menuData
   */
  _registerDiyScreen: function(menuData) {
    var content = document.querySelector('#' + this.pageContentId);
    var screen = document.createElement('things-diy-content');
    screen.layout = 'fullbleed layout vertical';
    screen.title = menuData.title;
    screen.dataRoute = menuData.routing;
    screen.currentRoute = menuData.routing;
    screen.resourceUrl = menuData.routing;
    screen.menuId = menuData.id;
    Polymer.dom(content).appendChild(screen);
    Polymer.dom.flush();

    if(screen.initializeContent)
      screen.initializeContent();
  },

  /**
   * RESOURCE 타입의 Dynamic Screen을 등록한다.
   * 
   * @param {Object} menuData
   */
  _registerResourceScreen: function(menuData) {
    var content = document.querySelector('#' + this.pageContentId);
    var screen = document.createElement('things-resource-content');
    screen.layout = 'fullbleed layout vertical';
    screen.title = menuData.title;
    screen.dataRoute = menuData.routing;
    screen.currentRoute = menuData.routing;
    screen.resourceType = menuData.name;
    screen.resourceUrl = menuData.routing;
    screen.detailView = menuData.detail_form_id;
    screen.enableDetailColumn = true;
    Polymer.dom(content).appendChild(screen);
    Polymer.dom.flush();

    if(screen.initializeContent)
      screen.initializeContent();
  },

  /**
   * move screen scroll to top
   */
  scrollToTop: function(ctx, next) {
    //app.scrollPageToTop();
    next();
  },

  /**
   *  add default routing
   *  @param {String} Default routing name
   */
  addDefaultRouting: function(defaultRouting, loginRouting) {
    page('/', this.scrollToTop, () => {
      app.route = defaultRouting;
    });

    page('/login', this.scrollToTop, () => {
      app.route = loginRouting;
    });

    page('/error_page', this.scrollToTop, () => {
      app.route = 'error_page';
    });    
  },

  /**
   * add last routing, when page not foud redirect to home
   */
  addLastRouting: function() {
    page('*', function(attempted) {
      let url = window.location.href + attempted.path.substr(1);
      // app.$.toastConfirm.text = `Can't find: ${url}. Redirected you to Home Page`;
      // app.$.toastConfirm.show();
      page.redirect('/');
    });
    
    page({
      hashbang: true
    });
  }
};
</script>
