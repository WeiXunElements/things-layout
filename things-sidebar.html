<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-badge/paper-badge.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">

<link rel="import" href="../things-ajax/things-ajax.html">
<link rel="import" href="../things-global-behavior/things-global-behavior.html">
<link rel="import" href="../things-i18n-msg/things-i18n-msg.html">

<link rel="import" href="./things-routing-behavior.html">

<!--
해당 Element는 
  1.things-routing-behavior.html를 사용하여 Routing 등록 및 설정을 수행한다.
  2.action에서 제공하는 Url로 Menu를 검색하여 Routing 등록 및 화면 좌측에 메뉴로 제공한다.
  3.메뉴성이기에 Drawer Attribute가 꼭 필요하다.

  Example:
    <things-sidebar drawer class="layout vertical" 
      title="MENU" screens="{{screens}}" action="menus.json?mode=auth">
    </things-sidebar>
-->

<dom-module id="things-sidebar">
  <template>
    <style>
      :host {
        display: block;
        background-color:#707070;
        color:#fff;
      }
      paper-scroll-header-panel {
        height: 100%;
      }
      .brand {
        background:#346597;
        min-height:37px;
        padding: 8px 0 0 50px;
        text-transform: capitalize;
      }
      paper-button {
        display: block;
        border-bottom: 1px solid rgba(0, 0, 0, .15);
        margin: 0;
        font-size: 14px;
        font-weight: 400;
        text-align: left;
        @apply(--border-radius-clear);
      }
      paper-button iron-icon {
        width: 15px;height: 15px;
        margin-top: -2px;
        margin-right: 4px
      }
      paper-listbox {
        background-color: rgba(0, 0, 0, .3);
        border-bottom: 1px solid rgba(0, 0, 0, .05);
        border-left: 2px solid var(--xmes-secondary-background-color);
        padding:0;
      }
      paper-item:before{
        content:"";
        display:inline-block;
        width:3px;height:3px;
        position:relative;
        top:-2px;
        margin-right:4px;
        background-color:rgba(255,255,255,.3);
      }
      paper-item {
        padding: 0 10px;
        display: block !important;
        min-height: 30px !important;
        border-bottom: 1px solid rgba(0, 0, 0, .1);
        font-size: 12px !important;
        color:rgba(255,255,255,.8);
        line-height: 2.5 !important
      }
      
      :host iron-collapse paper-item:hover,
      [selected] {
        
      }
    </style>

    <things-ajax
      auto
      id="refresh"
      resource-url="{{action}}"
      method="GET"
      content-type="application/json" 
      last-response="{{menu}}">
    </things-ajax>

    <div class="brand">
      <things-i18n-msg msgid="title.[[title]]" auto>[[title]]</things-i18n-msg>
    </div>

    <!-- Drawer Scroll Header Panel -->
    <paper-scroll-header-panel id = "panel">

      <content></content>

      <template is="dom-repeat" items="{{menuGroup}}" as=group>
        
        <!-- {{item}} and {{index}} can be used in this binding scope -->
        <paper-button aria-controls={{group.menuGroupId}} on-click="toggle">
          <iron-icon icon="icons:folder"></iron-icon>[[group.title]]
        </paper-button>

        <iron-collapse id="{{group.menuGroupId}}" tabindex="0">
          <paper-listbox selected-item ="{{_selectedMenu}}" class="content">
            <template is="dom-repeat" items="{{group.child}}" as=item>
              <paper-item data$="{{item}}">[[item.title]]</paper-item>
            </template>
          </paper-listbox>
        </iron-collapse>

      </template>
    </paper-scroll-header-panel>
  </template>

  <script>
    Polymer({
      is: 'things-sidebar',

      properties: {

        /**
         * 동적으로 메뉴 화면을 iron-pages내 content로 추가하기 위한 id 정보 
         */
        pageContentId : {
          type: String,
          value: 'content'
        },
        
        /**
         * Brand title that will be show on top of menu
         */
        title: {
          type: String
        },

        /**
         * url that where the menu data get from
         */
        action: {
          type: String
        },
        
        /**
         * menu group returns menu tree as Array
         * [ { 
         *    id: 1, name: 'System', title: 'System', menu_type: 'Menu', child: [ { child menus ...} ]
         * }, { 
         *    id: 2, name: 'Base', title: 'Base', menu_type: 'Menu', child: [ { child menus ...} ]
         * } ]
         */
        menuGroup: {
          type: Array,
          notify: true
        },

        /**
         * 메뉴 리스트 중에 App 안에 나타날 실제 화면 (menu_type이 'SCREEN') 정보.
         * 화면 정보들만 라우팅에 추가된다.
         */
        screens: {
          type: Array,
          notify: true,
          value :[]
        },

        /**
         * Resource Screen List
         */
        resourceScreens: {
          type: Array,
          notify: true,
          value: function() {
            return [];
          }
        },

        /**
         * Diy Screen List
         */
        diyScreens: {
          type: Array,
          notify: true,
          value: function() {
            return [];
          }
        },        
        /**
         * 현재 선택된 메뉴 정보 
         */
        _selectedMenu: {
          type: Object
        }
      },

      observers: [
        '_onChangeMenu(menu)',
        '_onSelectedMenuChange(_selectedMenu)'
      ],

      behaviors: [
        Things.RoutingBehavior,
        Things.GlobalBehavior
      ],

      /**
       * Life Cycle
       */
      attached: function() {
        this.addDefaultRouting('home', 'login');
      },
      
      /**
       * When last response data recieved this function will be called
       * then convert these data to menu tree and set to menuGroup
       * also convert to screen array and set to screens.
       * 
       * @param {Object} 메뉴 정보 menu.total : 총 메뉴 개수, menu.items : 메뉴 리스트 
       */
      _onChangeMenu: function(menu) {
        if(menu && menu.items.length > 0) {
          var groups = [], screens = [], rscScreens = [], diyScreens = [], me = this;

          menu.items.forEach(function(item) {
            if (item.menu_type === 'MENU') {
              item.child = me._getChildMenu(item, menu.items);
              item.menuGroupId = 'group' + item.id;
              groups.push(item);

            } else if(item.menu_type === 'SCREEN') {
              if(item.routing_type) {
                if(item.routing_type == 'RESOURCE') {
                  rscScreens.push(item);
                } else if(item.routing_type == 'DIY') {
                  diyScreens.push(item);
                }
              }

              screens.push(item);
            }
          });

          // ******** Routing 초기화 ***********
          this.init(screens, 'home', 'login');
          // *********************************

          this.menuGroup = groups;
          this.screens = screens;
          this.resourceScreens = rscScreens;
          this.diyScreens = diyScreens;          
        }
      },

      /**
       * Filter child menu and return it
       * @param  {Array} parent group id
       * @param  {Array} all menu list
       * @return {Array} child screen array
       */
      _getChildMenu: function(menuGroup, items) {
        return items.filter(function(item) {
          return (item && item.menu_type === 'SCREEN' && item.parent_id === menuGroup.id);
        });
      },

      /**
       * When selected menu changed route screen to the menu screen
       * @param  {String}
       */
      _onSelectedMenuChange: function(selectedMenu) {
        if(selectedMenu) {
          var data = JSON.parse(selectedMenu.getAttribute("data"));
          var url = '/' + (data.routing ? data.routing : '');
          page(url);
        }
      },

      /**
       * Refresh menu content
       * @param {Object} e 버튼 클릭 이벤트 
       */
      refreshmenu: function(e) {
        // TODO Check 메뉴를 리프레쉬하면 라우팅도 중복되어 추가될 듯 한데 체크 필요 
        this.$.refresh.generateRequest();
      },
      
      /**
       * Toggle menu group box
       * @param {Object} e 버튼 클릭 이벤트
       */
      toggle: function(e) {
        this.$$('#' + e.target.ariaControls).toggle();
      }

    });
  </script>
</dom-module>